{% load static %}

<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-rounded/css/uicons-solid-rounded.css" />
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-chubby/css/uicons-solid-chubby.css" />
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-bold-straight/css/uicons-bold-straight.css" />
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-solid-straight/css/uicons-solid-straight.css" />
    <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/3.0.0/uicons-bold-rounded/css/uicons-bold-rounded.css" />
    <title>Acceso - EstacionaTESCHI</title>
  </head>
  <body class="w-screen h-screen overflow-hidden">
    <nav class="p-4 bg-white shadow-md flex items-center justify-between h-[12%] w-full">
      <a class="start-0 flex items-center" href="/index/">
        <img src="{% static 'images/logo.png' %}" alt="" border="0" class="w-20 h-20 inline-block mr-2" />
        <span class="text-3xl font-bold text-[#0E549E]">Estaciona</span><span class="text-3xl font-bold text-[#7ABC44]">TESCHI</span>
      </a><div class="relative flex items-center gap-6">
        <button id="btnCameraIp" class="end-0 text-5xl cursor-pointer" title="Configurar cámara"><span class="fi fi-br-monitor-sun"></span></button>
        <a href="/access/" class="end-0 text-5xl cursor-pointer"><span class="fi fi-ss-time-past"></span></a>
      </div>
    </nav>
    <div>
      <div class="absolute w-full h-full flex">
        <div class="absolute h-full w-4/25 bg-[#053172] rounded-tr-[13vh] start-0 top-0"></div>
        <div class="absolute h-[76vh] w-4/25 bg-[#0064FA] rounded-tr-[13vh] start-0 bottom-0 z-2"></div>
        <img src="{% static 'images/bg-auto2.png' %}" alt="logo" border="0" class="w-[42vw] absolute bottom-3 start-0 z-3" />
      </div>
    </div>
    <div class="absolute start-4/25 top-[12%] z-5 flex flex-col w-full h-full">
      <div class="fixed start-0 text-4xl w-full text-center font-bold py-5 flex justify-center items-center">
        <h1 class="border-b-4 border-black px-90">Area de Acceso</h1>
      </div>
      <div class="relative top-[10%] flex w-full h-full">
        <div class="w-1/4 h-[76%]">
          <div class="flex flex-col justify-center items-center h-[65%] rounded-lg shadow-xl m-3 mx-5 border-2 border-gray-400/80 py-5">
            <div class="w-full p-5 text-xl flex gap-5">
              <span class="p-1 pr-2">Placa</span>
              <label id="detected-placa" class="bg-[#D9D9D9B0] p-1 rounded-lg flex-1 text-center" for="placa"></label>
            </div>
            <div class="w-full p-5 text-xl flex gap-5">
              <span class="p-1 pr-2">Modelo</span>
              <label id="detected-modelo" class="bg-[#D9D9D9B0] p-1 rounded-lg flex-1 text-center" for="modelo"></label>
            </div>
            <div class="w-full p-5 text-xl flex gap-5">
              <span class="p-1 pr-2">Cajon asignado</span>
              <label id="detected-cajon" class="bg-[#D9D9D9B0] p-1 rounded-lg flex-1 text-center" for="cajon"></label>
            </div>
            <div class="w-full p-5 text-xl flex gap-5">
              <span class="p-1 pr-2">Propietario</span>
              <label id="detected-propietario" class="bg-[#D9D9D9B0] p-1 rounded-lg flex-1 text-center" for="propietario"></label>
            </div>
            <div class="w-full p-5 text-xl flex gap-5">
              <span class="p-1 pr-2">Matricula</span>
              <label id="detected-matricula" class="bg-[#D9D9D9B0] p-1 rounded-lg flex-1 text-center" for="matricula"></label>
            </div>
          </div>
        </div>
        <div class="w-3/4 h-[75%] flex flex-col">
          <div class="w-[74%] h-4/5 rounded-lg shadow-xl m-2 border-2 border-red-500 flex items-center justify-center bg-black/10 relative overflow-hidden">
            <div id="streamOverlay" class="absolute inset-0 bg-black/60 text-white flex items-center justify-center text-xl font-semibold hidden">Detección pausada</div>
            <img id="cameraStream" alt="Stream cámara" class="w-full h-full object-cover rounded-lg" src="" />
          </div>
          <div class="w-[74%] h-1/5 rounded-lg shadow-xl m-2 border-2 border-gray-400/80">
            <div class="w-full h-full flex items-center flex flex-col">
              <span class="text-xl">Evento: Entrada</span>
              <div id="entry-box" class="w-[90%] text-2xl text-center m-3 bg-gray-300 p-5 rounded-xl">
                <label id="entry-label" for="entry">Sin placa detectada</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <!-- Modal para configurar la IP/URL de la cámara de detección de placas -->
  <div id="camera-create-modal" class="fixed inset-0 hidden flex items-center justify-center bg-black/50 z-50">
    <div class="bg-white rounded-lg w-2/3 p-8 relative">
      <button id="create-modal-close" class="absolute top-3 end-3 text-gray-600 text-2xl cursor-pointer">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Configurar detector de placas</h2>
      <form id="create-modal-form" class="grid grid-cols-1 md:grid-cols-1 gap-4">
        <input type="hidden" />
        <div>
          <label class="block text-sm font-medium">IP/URL de cámara</label>
          <input id="create-modal-ip" type="text" placeholder="Ej: http://192.168.1.28:8080/video" class="mt-1 w-full p-2 rounded bg-gray-200/80" />
          <div class="text-sm text-red-600 hidden mt-1" id="create-modal-error">Ingresa una IP o URL válida</div>
        </div>
        <div class="mt-4 flex justify-end gap-3">
          <button type="button" id="create-modal-cancel" class="px-6 py-2 bg-white border rounded-full cursor-pointer">Cancelar</button>
          <button id="create-modal-submit" type="submit" class="px-6 py-2 bg-black text-white rounded-full cursor-pointer">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    ;(function () {
      const modal = document.getElementById('camera-create-modal')
      const btn = document.getElementById('btnCameraIp')
      const closeBtn = document.getElementById('create-modal-close')
      const cancelBtn = document.getElementById('create-modal-cancel')
      const form = document.getElementById('create-modal-form')
      const input = document.getElementById('create-modal-ip')
      const error = document.getElementById('create-modal-error')
      const STORAGE_KEY = 'plate_source_ip'
      const entryBox = document.getElementById('entry-box')
      const entryLabel = document.getElementById('entry-label')
      const eventLabel = document.getElementById('event-label')
      const DEFAULT_BG = '#D1D5DB'
      const DEFAULT_TEXT = 'Sin placa detectada'
      let currentSource = null
      let pauseTimer = null
    
      function openModal() {
        const saved = localStorage.getItem(STORAGE_KEY) || ''
        input.value = saved
        error.classList.add('hidden')
        modal.classList.remove('hidden')
        modal.classList.add('flex')
        input.focus()
      }
    
      function closeModal() {
        modal.classList.add('hidden')
        modal.classList.remove('flex')
      }
    
      function validSource(v) {
        if (!v) return false
        const val = String(v).trim()
        // acepta URL http/https o IPv4 simple con opcional puerto y ruta
        const urlRegex = /^https?:\/\//i
        if (urlRegex.test(val)) return true
        const ipv4 = val.match(/^(\d{1,3})(?:\.(\d{1,3})){3}(?::\d+)?(?:\/.*)?$/)
        if (!ipv4) return false
        return val.split('.')[0].length > 0
      }
    
      async function startDetector(source) {
        try {
          await fetch(`/plates/control_by_ip/?ip=${encodeURIComponent(source)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'start' })
          })
        } catch (err) {
          console.warn('No se pudo iniciar el detector', err)
        }
      }
    
      async function stopDetector(source) {
        try {
          await fetch(`/plates/control_by_ip/?ip=${encodeURIComponent(source)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'stop' })
          })
        } catch (err) {
          console.warn('No se pudo detener el detector', err)
        }
      }
    
      function setStream(source, refresh = false) {
        const img = document.getElementById('cameraStream')
        const overlay = document.getElementById('streamOverlay')
        if (!img) return
        if (!source) {
          img.src = ''
          if (overlay) {
            overlay.classList.remove('hidden')
            overlay.innerText = 'Detección pausada'
          }
          return
        }
        const url = `/plates/stream_by_ip/?ip=${encodeURIComponent(source)}${refresh ? `&t=${Date.now()}` : ''}`
        if (overlay) overlay.classList.add('hidden')
        if (refresh) {
          img.src = ''
          // slight delay to ensure reload
          setTimeout(() => {
            img.src = url
          }, 50)
        } else {
          img.src = url
        }
      }
    
      async function lookupVehicle(placa) {
        try {
          const res = await fetch(`/plates/lookup/?placa=${encodeURIComponent(placa)}`)
          if (!res.ok) return { found: false }
          return await res.json()
        } catch (err) {
          console.warn('lookup error', err)
          return { found: false }
        }
      }
    
      async function logAccess(placa, tipo = 'ENTRADA') {
        if (!placa) return
        try {
          await fetch('/plates/log_access/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ placa, tipo })
          })
        } catch (err) {
          console.warn('log access error', err)
        }
      }
    
      function applyVehicleInfo(info) {
        const placaEl = document.getElementById('detected-placa')
        const modeloEl = document.getElementById('detected-modelo')
        const propEl = document.getElementById('detected-propietario')
        const matEl = document.getElementById('detected-matricula')
        const cajonEl = document.getElementById('detected-cajon')
        if (!info || !info.found) {
          placaEl.innerText = info && info.placa ? info.placa : ''
          modeloEl.innerText = ''
          propEl.innerText = ''
          matEl.innerText = ''
          cajonEl.innerText = ''
          if (entryBox) entryBox.style.backgroundColor = '#FF4B4B'
          if (entryLabel && info && info.placa) entryLabel.innerText = `${info.placa} - ACCESO NO AUTORIZADO`
          if (eventLabel) eventLabel.innerText = 'Acceso no autorizado'
          return
        }
    
        const usuario = info.usuario || {}
        placaEl.innerText = info.placa || ''
        modeloEl.innerText = `${info.marca || ''} ${info.modelo || ''}`.trim()
        propEl.innerText = `${usuario.nombre || ''} ${usuario.apellidos || ''}`.trim()
        matEl.innerText = usuario.matricula || ''
        cajonEl.innerText = ''
        if (entryBox) entryBox.style.backgroundColor = '#45FF6D'
        if (entryLabel) entryLabel.innerText = `${info.placa} - ACCESO AUTORIZADO`
        if (eventLabel) eventLabel.innerText = 'Acceso autorizado'
      }
    
      let lastLookupPlate = null
    
      function resetUi() {
        const placaEl = document.getElementById('detected-placa')
        const modeloEl = document.getElementById('detected-modelo')
        const propEl = document.getElementById('detected-propietario')
        const matEl = document.getElementById('detected-matricula')
        const cajonEl = document.getElementById('detected-cajon')
        placaEl.innerText = ''
        modeloEl.innerText = ''
        propEl.innerText = ''
        matEl.innerText = ''
        cajonEl.innerText = ''
        if (entryBox) entryBox.style.backgroundColor = DEFAULT_BG
        if (entryLabel) entryLabel.innerText = DEFAULT_TEXT
        if (eventLabel) eventLabel.innerText = ''
      }
    
      function stopPolling() {
        if (pollHandle) {
          clearInterval(pollHandle)
          pollHandle = null
        }
      }
    
      async function pauseAndResumeDetection() {
        stopPolling()
        if (currentSource) {
          setStream('', true)
          await stopDetector(currentSource)
          if (pauseTimer) clearTimeout(pauseTimer)
          pauseTimer = setTimeout(async () => {
            resetUi()
            lastLookupPlate = null
            await startDetector(currentSource)
            setStream(currentSource, true)
            startPolling(currentSource)
          }, 5000)
        }
      }
    
      async function setPlate(text, ts) {
        const placaEl = document.getElementById('detected-placa')
        if (!text) {
          placaEl.innerText = ''
          applyVehicleInfo({ found: false })
          if (entryBox) entryBox.style.backgroundColor = DEFAULT_BG
          if (entryLabel) entryLabel.innerText = DEFAULT_TEXT
          if (eventLabel) eventLabel.innerText = ''
          lastLookupPlate = null
          return
        }
    
        if (text !== lastLookupPlate) {
          lastLookupPlate = text
          const info = await lookupVehicle(text)
          applyVehicleInfo(info)
          if (info && info.found) {
            await logAccess(text, 'ENTRADA')
            await pauseAndResumeDetection()
          }
        }
      }
    
      let pollHandle = null
      function startPolling(source) {
        if (pollHandle) clearInterval(pollHandle)
        if (!source) return
    
        pollHandle = setInterval(async () => {
          try {
            const res = await fetch(`/plates/status_by_ip/?ip=${encodeURIComponent(source)}`)
            if (!res.ok) return
            const data = await res.json()
            setPlate(data.last_plate || null, data.last_plate_at || null)
          } catch (err) {
            console.warn('poll status error', err)
          }
        }, 1200)
      }
    
      btn?.addEventListener('click', openModal)
      closeBtn?.addEventListener('click', closeModal)
      cancelBtn?.addEventListener('click', closeModal)
      modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal()
      })
    
      form?.addEventListener('submit', async function (e) {
        e.preventDefault()
        const val = input.value.trim()
        if (!validSource(val)) {
          error.classList.remove('hidden')
          return
        }
        const source = val
        localStorage.setItem(STORAGE_KEY, String(source))
        currentSource = source
        closeModal()
        await startDetector(source)
        setStream(source)
        startPolling(source)
      })
    
      document.addEventListener('DOMContentLoaded', async function () {
        if (entryBox) {
          entryBox.style.backgroundColor = DEFAULT_BG
          if (entryLabel) entryLabel.innerText = DEFAULT_TEXT
        }
    
        const saved = localStorage.getItem(STORAGE_KEY)
        if (validSource(saved)) {
          const source = saved
          currentSource = source
          await startDetector(source)
          setStream(source)
          startPolling(source)
        }
      })
    })()
  </script>
</html>
